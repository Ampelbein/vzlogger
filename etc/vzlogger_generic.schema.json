/*
  use http://jeremydorn.com/json-editor/ as editor (paste below into schema)

  todo: for some meter (with periodic=true, interval needs to be positive)
  todo: for meter the option skip is actually called "allowskip"?
  todo: dependency for aggmode!=none and aggtime             "dependencies": {
                "aggmode": ["aggtime"],
                "aggtime": ["aggmode"]
            }
    todo: "meters" can be called "sensors" as well
    todo: add regex for uuid (see config_validate_uuid())
    todo: enum for api (mysmartgrid, null, volkszaehler)
    todo: enum for protocol (d0, sml, fluksov2, file, exec, s0)
    todo: meterD0 needs device or host
    todo: add "off" to "wait_sync"
  */
{
    "$schema": "http://json-schema.org/draft-04/schema#",

    "definitions" : {

        "local": {
            "type": "object",
            "properties": {
                "enabled": {
                    "id": "/local/enabled",
                    "type": "boolean",
                    "description": "should we start the local HTTPd for serving live readings?"
                },
                "port": {
                    "id": "/local/port",
                    "type": "integer",
                    "default": 8080,
                    "description": "the TCP port for the local HTTPd"
                },
                "index": {
                    "id": "/local/index",
                    "type": "boolean",
                    "description": "should we provide a index listing of available channels if no UUID was requested?"
                },
                "timeout": {
                    "id": "/local/timeout",
                    "type": "integer"
                },
                "buffer": {
                    "id": "/local/buffer",
                    "type": "integer"
                }
            },
            "required": [ "enabled" ]
        },

        "channel": {
            "type": "object",
            "title": "channel",
            "properties": {
                "uuid": { "type": "string", "description": "uuid of this channel towards the middleware" },
                "identifier": { "type": "string", "description": "identifier of this channel from the meter. E.g. 1-0:1.8.0" },
                "api": {
                    "type": "string",
                    "enum": ["volkszaehler", "mysmartgrid", "null"],
                    "default": "volkszaehler",
                    "description": "middleware api to be used. Defaults to volkszaehler.org"
                },
                "aggmode": {
                    "type": "string",
                    "enum": ["avg", "max", "sum", "none"],
                    "description": "Mittelwert fuer Leistung, MAX fuer Zaehler, SUM fuer Counter",
                    "default": "none"
                },
                "duplicates": {
                    "type": "integer",
                    "minimum": 0,
                    "default": 0,
                    "description": "default 0 (send duplicate values), >0 = send duplicate values only each <duplicates> seconds. Activate only for abs. counter values (Zaehlerstaende) and not for impulses!"
                }
            },
            "required": ["uuid", "identifier"]
        },

        "meter": {
            "type": "object",
            "title": "meter",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "description": "enable or disable this meter. Disabled meter will be ignored.",
                    "default": false
                },
                "allowskip": {
                    "type": "boolean",
                    "description": "if enabled, errors when opening meter will lead to meter being ignored",
                    "default": false
                },
                "interval": {
                    "type": "integer",
                    "description": "delay in secs between queries to the meter",
                    "default": -1
                },
                "aggtime": {
                    "type": "integer",
                    "description": "aggregate all signals and give one update to middleware every <aggtime> seconds",
                    "default": -1
                },
                "aggfixedinterval": {
                    "type": "boolean",
                    "description": "round all timestamps to middleware to nearest aggtime",
                    "default": false
                },
                "channels": {"$ref": "#/definitions/channels"}
            },
            "required": [  ]
        },

        "meterS0": {
            "title": "S0 based meter",
          "allOf": [
            { "$ref": "#/definitions/meter" },
            { "properties": {
                "protocol": { "type": "string", "enum": ["s0"] },
                "device": { "type": "string", "description": "device the meter is connected to. E.g. /dev/ttyUSB0" }
            },
            "required": [ "protocol", "device" ]
            }
          ]
        },

        "meterD0": {
            "title": "D0 based meter",
            "allOf": [
                { "$ref": "#/definitions/meter" },
                { "properties": {
                        "protocol": { "type": "string", "enum": ["d0"] },
                        "device": { "type": "string", "description": "device the meter is connected to. E.g. /dev/ttyUSB0" },
                        "host": { "type": "string", "description": "ip addr of the meter (if not directly connected)" },
                        "dump_file": { "type": "string", "description": "path/filename of the file for the serial dump" },
                        "pullseq": { "type": "string", "description": "todo with default" },
                        "ackseq": { "type": "string", "description": "todo", "default": "auto" },
                        "baudrate": { "enum": [50, 75, 110, 134, 150, 200, 300, 600, 1200, 1800, 2400, 4800, 9600, 19200, 38400, 57600, 115200, 230400], "default": 300, "description": "todo" },
                        "baudrate_read":  { "enum": [50, 75, 110, 134, 150, 200, 300, 600, 1200, 1800, 2400, 4800, 9600, 19200, 38400, 57600, 115200, 230400], "default": 300, "description": "todo" },
                        "parity": { "enum": ["8n1", "7n1", "7e1", "7o1"], "default": "7e1", "description": "todo"},
                        "wait_sync": { "enum": ["end", "off"], "default": "off", "description": "todo"},
                        "read_timeout": { "type": "integer", "default": 10, "description": "todo"},
                        "baudrate_change_delay": {"type": "integer", "default": 0, "description": "todo"}
                    }
                }
            ]
        },

        "channels": {
            "type": "array",
            "items": { "oneOf": [
                    {"$ref": "#/definitions/channel"}
                ]}
        },

        "meters": {
            "type": "array",
            "minItems": 1,
            "items": { "oneOf": [
                    {"$ref": "#/definitions/meterS0"},
                    {"$ref": "#/definitions/meterD0"}
                ]}
        }

    },

  "type": "object",
  "properties": {
    "retry": {
      "id": "/retry",
      "type": "integer",
      "description": "How long to sleep between failed requests, in seconds"
    },
    "daemon": {
      "id": "/daemon",
      "type": "boolean",
      "default": "true",
      "description": "Enable daemon mode"
    },
    "verbosity": {
      "id": "/verbosity",
      "type": "integer",
      "enum":[0, 5, 10, 15], "description":"log_error or log_warning",
      "default": 0,
      "description": "0 = log_error or log-warning, 5 = log_info, 10 = log-debug, 15 = log_finest"
    },
    "log": {
      "id": "/log",
      "type": "string",
      "description": "path to log file"
    },
    "local": { "$ref": "#/definitions/local" },
    "meters": { "$ref": "#/definitions/meters" }
  },
  "required": [
    "daemon",
    "log"
  ]
}
